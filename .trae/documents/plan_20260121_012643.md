# X Algorithm PHP 单元测试覆盖计划

## 现状分析

### 代码统计
- **源代码文件**: 39 个 PHP 文件，共 2827 行代码
- **现有测试**: 仅 2 个测试文件（230 个测试用例）
- **测试框架**: 自定义测试框架，未使用 PHPUnit

### 当前问题
1. ❌ 未使用 PHPUnit 官方测试框架
2. ❌ 缺少 PHPUnit 配置文件（phpunit.xml）
3. ❌ 缺少 Mocking 框架（Mockery 或 PHPStub）
4. ❌ 测试未按模块组织（全部在 2 个大文件中）
5. ❌ 缺少数据提供者（Data Providers）
6. ❌ 缺少测试生命周期钩子（setUp/tearDown）
7. ❌ 缺少代码覆盖率报告配置

---

## 实施计划

### 第 1 阶段：基础设施搭建（2 小时）

#### 1.1 更新 composer.json 添加测试依赖
```json
{
    "require-dev": {
        "phpunit/phpunit": "^10.0",
        "mockery/mockery": "^1.6",
        "phpstan/phpstan": "^1.10"
    }
}
```

#### 1.2 创建 PHPUnit 配置文件
- 创建 `phpunit.xml` 配置
- 配置测试套件
- 配置代码覆盖率报告
- 配置测试数据目录

#### 1.3 创建测试目录结构
```
tests/
├── Unit/
│   ├── DataStructures/
│   │   ├── PostCandidateTest.php
│   │   ├── PhoenixScoresTest.php
│   │   ├── ScoredPostsQueryTest.php
│   │   └── UserFeaturesTest.php
│   ├── Filters/
│   │   ├── AgeFilterTest.php
│   │   ├── MutedKeywordFilterTest.php
│   │   └── ...（11 个过滤器测试）
│   ├── Scorers/
│   │   ├── WeightedScorerTest.php
│   │   ├── AuthorDiversityScorerTest.php
│   │   └── ...（4 个评分器测试）
│   ├── Selectors/
│   │   └── TopKScoreSelectorTest.php
│   ├── Sources/
│   │   ├── ThunderSourceTest.php
│   │   └── PhoenixSourceTest.php
│   └── Utility/
│       └── RequestIdGeneratorTest.php
├── Integration/
│   ├── CandidatePipelineTest.php
│   └── HomeMixerServiceTest.php
├── Feature/
│   └── AlgorithmTest.php
├── Helpers/
│   ├── MockPostCandidateTrait.php
│   └── MockPhoenixClientTrait.php
└── TestCase.php
```

---

### 第 2 阶段：数据结构测试（3 小时）

#### 2.1 PostCandidateTest.php
- [ ] 测试构造函数初始化
- [ ] 测试 toArray() 和 fromArray()
- [ ] 测试 getScreenNames()
- [ ] 测试 getLookupTweetId() 和 getLookupAuthorId()
- [ ] 测试 retweeted 场景
- [ ] 测试 phoenixScores 处理

#### 2.2 PhoenixScoresTest.php
- [ ] 测试构造函数和属性赋值
- [ ] 测试 toArray() 和 fromArray() 转换
- [ ] 测试 getWeightedEngagementScore()
- [ ] 测试各种分数类型
- [ ] 测试空值处理

#### 2.3 ScoredPostsQueryTest.php
- [ ] 测试构造函数和默认値
- [ ] 测试 hasSeenTweet()
- [ ] 测试 isMutedKeyword()
- [ ] 测试 isBlockedAuthor()
- [ ] 测试 userActionSequence 转换

#### 2.4 UserFeaturesTest.php
- [ ] 测试所有属性初始化
- [ ] 测试 toArray() 导出
- [ ] 测试边界条件（空数组、null 值）

---

### 第 3 阶段：过滤器测试（4 小时）

#### 3.1 为每个过滤器创建独立测试文件
- AgeFilterTest: 年龄边界条件测试
- MutedKeywordTest: 关键词匹配、大小写敏感
- DropDuplicatesFilterTest: 去重逻辑
- AuthorSocialgraphFilterTest: 黑名单/静音作者
- SelfTweetFilterTest: 自推文过滤
- RetweetDeduplicationFilterTest: 转发去重
- DedupConversationFilterTest: 会话去重
- PreviouslySeenPostsFilterTest: 已阅过滤
- PreviouslyServedPostsFilterTest: 已服务过滤
- IneligibleSubscriptionFilterTest: 订阅资格
- FilterManagerTest: 组合过滤器管理

#### 3.2 测试内容
- [ ] 基本过滤功能
- [ ] 边界条件（空输入、全过滤）
- [ ] 性能测试（大数据量）
- [ ] 异常处理

---

### 第 4 阶段：评分器测试（3 小时）

#### 4.1 WeightedScorerTest
- [ ] 测试权重计算
- [ ] 测试自定义权重
- [ ] 测试空 phoenixScores
- [ ] 测试边界值

#### 4.2 AuthorDiversityScorerTest
- [ ] 测试多样性衰减
- [ ] 测试不同作者场景
- [ ] 测试边界条件

#### 4.3 OONScorerTest
- [ ] 测试网络内/外判断
- [ ] 测试 boost factor

#### 4.4 PhoenixScorerTest（需要 Mock）
- [ ] 测试 ML 预测调用
- [ ] 测试错误处理
- [ ] 测试空序列处理

---

### 第 5 阶段：其他组件测试（2 小时）

#### 5.1 TopKScoreSelectorTest
- [ ] 测试 Top K 选择
- [ ] 测试分数字段选择
- [ ] 测试空输入

#### 5.2 ThunderSourceTest
- [ ] 测试 fetch 返回结构
- [ ] 测试 inNetworkOnly 逻辑

#### 5.3 PhoenixSourceTest（需要 Mock）
- [ ] 测试 Phoenix 客户端调用
- [ ] 测试候选构建

#### 5.4 RequestIdGeneratorTest
- [ ] 测试 ID 生成唯一性
- [ ] 测试时间戳提取
- [ ] 测试边界条件

---

### 第 6 阶段：集成测试（3 小时）

#### 6.1 CandidatePipelineTest
- [ ] 测试完整管道执行
- [ ] 测试各阶段数据流
- [ ] 测试统计信息
- [ ] 测试边界条件

#### 6.2 HomeMixerServiceTest
- [ ] 测试 getRecommendations
- [ ] 测试 getPersonalizedRecommendations
- [ ] 测试配置更新
- [ ] 测试 Phoenix 客户端设置

---

### 第 7 阶段：测试优化（1 小时）

#### 7.1 添加数据提供者
- 为重复测试添加 @dataProvider

#### 7.2 添加测试生命周期
- 使用 setUp() 和 tearDown()

#### 7.3 添加测试 Traits
- MockPostCandidateTrait
- MockPhoenixClientTrait

#### 7.4 配置 CI/CD
- GitHub Actions 配置
- 自动化测试运行

---

## 预期成果

1. **测试文件**: 20+ 个独立测试文件
2. **测试用例**: 300+ 个单元测试
3. **代码覆盖率**: 目标 80%+
4. **测试框架**: 完整的 PHPUnit 架构
5. **Mocking**: 完整的 Mock 基础设施

## 时间预估

| 阶段 | 时间 |
|------|------|
| 第 1 阶段：基础设施 | 2 小时 |
| 第 2 阶段：数据结构测试 | 3 小时 |
| 第 3 阶段：过滤器测试 | 4 小时 |
| 第 4 阶段：评分器测试 | 3 小时 |
| 第 5 阶段：其他组件测试 | 2 小时 |
| 第 6 阶段：集成测试 | 3 小时 |
| 第 7 阶段：优化 | 1 小时 |
| **总计** | **18 小时** |